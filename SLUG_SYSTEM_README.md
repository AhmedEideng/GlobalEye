# نظام إدارة روابط الأخبار (Slugs System)

## نظرة عامة

تم تحسين نظام توليد وإدارة روابط الأخبار (slugs) ليعمل بشكل أفضل مع الأخبار الجديدة والقديمة. النظام الآن يتضمن:

- توليد تلقائي للروابط من عناوين الأخبار
- فحص وتحسين الروابط الموجودة
- واجهة إدارة متقدمة
- trigger تلقائي في قاعدة البيانات

## الميزات الجديدة

### 1. توليد ذكي للروابط
- تنظيف العناوين من الأحرف الخاصة
- إزالة الأحرف العربية والرموز غير المرغوبة
- إضافة hash من URL لضمان التفرد
- تحديد طول مناسب للروابط

### 2. فحص وتحسين الروابط
- كشف الروابط الفارغة أو غير الصحيحة
- كشف الروابط الطويلة جداً أو القصيرة جداً
- تحسين الروابط التي تحتوي على "undefined" أو "null"

### 3. واجهة إدارة متقدمة
- عرض إحصائيات مفصلة
- فحص حالة الروابط في الوقت الفعلي
- تحديث جميع الروابط دفعة واحدة
- عرض تفاصيل التحديثات

## كيفية الاستخدام

### 1. الوصول لواجهة الإدارة
```
http://localhost:3000/admin/update-slugs
```

### 2. فحص حالة الروابط
- اضغط على "فحص حالة الروابط" لعرض الإحصائيات
- ستظهر لك:
  - إجمالي عدد الأخبار
  - عدد الأخبار بروابط جيدة
  - عدد الأخبار بدون روابط
  - عدد الروابط التي تحتاج تحسين
  - نسبة الروابط الجيدة

### 3. تحديث جميع الروابط
- اضغط على "تحديث جميع الروابط" لتوليد/تحسين جميع الروابط
- سيتم تحديث:
  - الأخبار بدون روابط
  - الروابط غير الصحيحة
  - الروابط الطويلة أو القصيرة جداً

### 4. استخدام API مباشرة

#### فحص حالة الروابط
```bash
GET /api/update-slugs?action=check-status
```

#### تحديث جميع الروابط
```bash
POST /api/update-slugs
```

#### تحسين رابط محدد
```bash
POST /api/update-slugs
Content-Type: application/json

{
  "action": "improve-specific",
  "articleId": "article-id-here"
}
```

## إعداد Trigger تلقائي في Supabase

### 1. فتح SQL Editor في Supabase Dashboard

### 2. تشغيل ملف SQL
انسخ محتوى ملف `supabase-slug-trigger.sql` والصقه في SQL Editor

### 3. تشغيل الأوامر
```sql
-- فحص حالة الروابط
SELECT * FROM check_slugs_status();

-- تحديث جميع الروابط الموجودة
SELECT * FROM update_all_existing_slugs();
```

## كيفية عمل النظام

### 1. للأخبار الجديدة
- عند إدخال خبر جديد، يتم توليد رابط تلقائياً
- إذا كان هناك trigger في قاعدة البيانات، سيتم التوليد على مستوى قاعدة البيانات
- إذا لم يكن هناك trigger، سيتم التوليد في التطبيق

### 2. للأخبار القديمة
- يمكن تحديث جميع الأخبار الموجودة دفعة واحدة
- يتم فحص كل خبر وتحديد ما إذا كان يحتاج إلى رابط جديد
- يتم تحسين الروابط غير الصحيحة

### 3. خوارزمية توليد الروابط
```typescript
function generateSlug(title: string, url: string): string {
  // تنظيف العنوان
  let cleanTitle = title
    .toLowerCase()
    .trim()
    .replace(/[^\w\s-]/g, '')  // إزالة الأحرف الخاصة
    .replace(/[\s\-]+/g, '-')  // استبدال المسافات بشرطات
    .replace(/^-+|-+$/g, '')   // إزالة الشرطات من البداية والنهاية
    .slice(0, 50);             // تحديد الطول الأقصى
  
  // إضافة hash من URL لضمان التفرد
  const urlHash = Math.abs(hashCode(url)).toString().slice(0, 8);
  return `${cleanTitle}-${urlHash}`;
}
```

## أمثلة على الروابط المولدة

### قبل التحسين
```
"Breaking News: Major Event Happens Today!" 
→ "breaking-news-major-event-happens-today-12345678"
```

### بعد التحسين
```
"Breaking News: Major Event Happens Today!" 
→ "breaking-news-major-event-happens-today-12345678"
```

## استكشاف الأخطاء

### 1. الروابط لا تتولد
- تأكد من وجود عنوان للخبر
- تحقق من اتصال قاعدة البيانات
- راجع سجلات الأخطاء في console

### 2. الروابط غير صحيحة
- استخدم "فحص حالة الروابط" لتحديد المشاكل
- اضغط "تحديث جميع الروابط" لإصلاح المشاكل

### 3. الأداء بطيء
- تأكد من وجود indexes على slug و url
- قم بتحديث الروابط على دفعات صغيرة

## الأمان والتحسينات

### 1. التحقق من التفرد
- كل رابط يحتوي على hash من URL لضمان التفرد
- لا يمكن أن يكون هناك رابطين متطابقين

### 2. الأداء
- تم إنشاء indexes على slug و url
- يتم تحديث الروابط بشكل فعال

### 3. المرونة
- النظام يعمل مع الأخبار الجديدة والقديمة
- يمكن تخصيص خوارزمية توليد الروابط

## الدعم

إذا واجهت أي مشاكل:
1. راجع سجلات الأخطاء في console
2. تحقق من حالة قاعدة البيانات
3. استخدم "فحص حالة الروابط" لتحديد المشاكل
4. راجع ملف `supabase-slug-trigger.sql` للتأكد من إعداد Trigger 